<link rel="stylesheet" href="../../polymerTest/css/leaflet.css">
<link rel="stylesheet" href="../../polymerTest/css/map.css">
<script src="../libs/leaflet.js"></script>
<link rel="import" href="../bower_components/polymer/polymer.html">

<polymer-element name="map-element" attributes="name sessionName" extends="webrtc-element" constructor="MapElement">
  <template>
    <div id="map"></div>
  </template>

  <script>
  Polymer('map-element',{
    
    ready: function(){
      this.super();
    },

    initialize: function(channelID){
      this.super([channelID, {data:true}]);
      this.connection.sessionid = ("map_" + this.connection.channel);
	  var mapEl = this.shadowRoot.querySelector("#map");
      
      var myIcon = L.icon({
    	    iconUrl: 'libs/images/marker-icon.png',
    	    iconRetinaUrl: 'libs/images/marker-icon-2x.png',
    	    iconSize: [38, 95],
    	    iconAnchor: [22, 94],
    	    popupAnchor: [-3, -76],
    	    shadowUrl: 'libs/images/marker-shadow.png',
    	    shadowRetinaUrl: 'libs/images/marker-shadow.png',
    	    shadowSize: [68, 95],
    	    shadowAnchor: [22, 94]
    	});

        var map = L.map(mapEl).setView([51.505, -0.09], 13);
 	    var markerLayer = L.layerGroup([]);
 	    this.mLayer = markerLayer;
 	    markerLayer.addTo(map);
      
        this.isMapUpdated = true;
 	  
        //var TILE_LOCATION = 'http://{s}.tile.cloudmade.com/795f9e9d19094307867649e8d21d3f46/997/256/{z}/{x}/{y}.png';
        var TILE_LOCATION = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
	    L.tileLayer(TILE_LOCATION, {
		    maxZoom: 18,
		    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>'
  	    }).addTo(map);
	    console.log("map yo");
      
  	    var con = this.connection;

  	    function onMapClick(e) {
  		  markerLayer.addLayer(L.marker(e.latlng, {icon:myIcon, draggable:'false'}))
  		  //var jsonMarker = JSON.stringify({"type":"marker", "latlng": e.latlng});
  		  con.send({"type":"marker", "latlng": e.latlng});
  		  console.log(con);
  	    }

  	    map.on('click', onMapClick);

        this.connection.onmessage = function(e){
    	  //console.log(e.data);
      	  //var jsonMessage = JSON.parse(message);
		  console.log("message received");
      	  if (e.data.type === "marker"){
    		  //var jsonMarker = JSON.parse(message);
    		  markerLayer.addLayer(L.marker(e.data.latlng, {icon:myIcon, draggable:'false'}));
      	  }
      	  else if (e.data.type === "mapRequest"){
      	  //var jsonMarkers = JSON.stringify({"type":"markerLayer", "markers": markerLayer})
      	    con.send({type: "markerLayer", markers: markerLayer});
      	  }
      	  else if (e.data.type === "markerLayer" && !this.isMapUpdated){
      	    markerLayer = e.data.markers;
      		  //JSON.parse(message).markers;
      	    this.isMapUpdated = true;
      	  }
        };
      
      
        this.mLayer.clearLayers();
        this.isMapUpdated = false;
        //var mapRequest = JSON.stringify({"type":"mapRequest"});
        //this.connection.sendCustomMessage(mapRequest);
    }
  });
  </script>
</polymer-element>
