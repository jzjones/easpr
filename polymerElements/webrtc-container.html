<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/platform/platform.js">

<link rel='import' href='./webrtc-element.html'>
<link rel='import' href='./videochat-element.html'>
<link rel='import' href='./textchat-element.html'>
<link rel='import' href="./map-element.html">

<link rel='import' href="../bower_components/polymer-ui-collapsible/polymer-ui-collapsible.html">
<link rel="import" href="../bower_components/polymer-ui-splitter/polymer-ui-splitter.html">
<link rel="stylesheet" href="../bower_components/polymer-flex-layout/polymer-flex-layout.css">
<link rel="stylesheet" href="../bower_components/polymer-ui-base-css/base.css">




<polymer-element name="webrtc-container" attributes="name sessionName" extends="webrtc-element" constructor='WebRTCContainer'>
  <template>
      <style>
        body {
          -webkit-user-select: none;
          -moz-user-select: none;
          -webkit-tap-highlight-color: rgba(0,0,0,0);
        }
        
        .container {
          width: 1200px;
          height: 600px;
          border: 4px solid #aaa;
        }
        
        /*.container div {
          overflow: hidden;
        }*/
        
        #videoDiv {
          width: 100%;
          height: 100%;
        }
        
        polymer-ui-splitter {
        display: block;
        width: 10px;
        background-image: url(http://www.polymer-project.org/components/polymer-ui-splitter/handle.png);
        background-color: rgb(239, 239, 239);
        box-shadow: rgb(204, 204, 204) 0px 0px 2px 1px inset;
        opacity: 0.9;
        cursor: col-resize;
        background-position: 50% 50%;
        background-repeat: no-repeat no-repeat;
        background-color: rgb(221, 221, 221);
        }
        #layout{
          width:100%;
          height: 100%;
          -webkit-transition:width 0.2s ease-in-out;
    	  -moz-transition:width 0.2s ease-in-out;
    	  -o-transition:width 0.2s ease-in-out;
    	  transition:width 0.2s ease-in-out;
    	  float: right;
        }
        #menu{
          width: 250px;
          top:64px;
        }
        #openMenu{
          height: 98%;
        }
        #textDiv{
          /*height:93% for including addMap button*/
          height: 97%;
          background: #660066;
        }
        #flexbox{
          width: 100%;
        }
        #mapDiv{
          height:100%; 
          width:100%;
        }
        #flex {
          height:100%;
          overflow-x:hidden;
        }
        #no-flex {
          width:100%;
        }
    </style>
  
    <div id='layout'>
    
      <a id="menuLink" on-click='{{menuHelper}}' class="menu-link">
        <span></span>
      </a>
    
      <div id="menu">
        <div id='openMenu' class="pure-menu pure-menu-open">
          <div id="textDiv">
           <!--  <button on-click="{{addMap}}" style='width:100%'>Add Map</button> -->
          </div>

        </div>
      </div>
   
      <div id='flexbox' class="container flexbox">
        <div id='no-flex'>
      	   <div id="videoDiv"></div>
        </div>
        <polymer-ui-splitter direction="left"></polymer-ui-splitter>
        <div id='flex' flex>
      	 <div id="mapDiv"></div>
        </div>
      </div>
    </div>
  </template>

  <script>
  Polymer('webrtc-container',{
       
    ready: function(){
      this.super();
    },
    
    initialize: function(channelID){
      var session = {audio: false, video: false, screen: false, data: true};
      this.super([channelID, session]);
      this.addText();
      /*var btn = document.createElement("button");
      btn.innerHTML="Add Map";
      btn.addEventListener('click', this.addMap, false);
      btn.style.width='93%';
      btn.style.marginTop = "2.4em";
      btn.style.marginLeft = "0.5em";
      btn.className = "pure-button pure-button-primary";
      this.shadowRoot.querySelector('#textDiv').appendChild(btn);*/
      this.addVideo();
      this.mapDiv = this.shadowRoot.querySelector("#mapDiv");
      this.addMap();
    },
    
    menuHelper: function(){
      var active = 'active';
      this.toggleClass(this.shadowRoot.querySelector("#layout"), active);
      this.toggleClass(this.shadowRoot.querySelector('#menu'), active);
      this.toggleClass(this.shadowRoot.querySelector('#menuLink'), active);
    },
    
    addElements: function(attempt, cbObj){
      this.addVideo(attempt);
      cbObj.addText(attempt);
    },
    
    addVideo: function(){
      var vidEl = new VideoChatElement();
      this.channelData = this.connection.channel;
      vidEl.initialize(this.connection.channel);
      this.shadowRoot.querySelector('#videoDiv').appendChild(vidEl);
      vidEl.findRoom();
    },
    
    addText: function(){
      var textEl = new TextChatElement();
      textEl.initialize(this.connection.channel);
      this.shadowRoot.querySelector('#textDiv').appendChild(textEl);
      textEl.findRoom();
    },
    
    addMap: function(){
      var mapEl = new MapElement();
      console.log('mapDiv again '+ this.mapDiv);
      mapEl.initialize(this.channelData);
      this.mapDiv.appendChild(mapEl);
      mapEl.findRoom();
    },
    
    removeVideo: function(){
      var vidEl = this.shadowRoot.querySelector('#videoDiv').querySelector("videochat-element");
      vidEl.end();
      this.shadowRoot.querySelector('#videoDiv').removeChild(vidEl);
    },
    
    removeText: function(){
      var textEl = this.$textDiv.querySelector("textchat-element");
      textEl.end();
      this.$.textDiv.removeChild(textEl);
    },
    
    removeAll: function(){
      var vidEl = this.$.videoDiv.querySelector("videochat-element");
      var numUsers=vidEl.connection.stats.numberOfConnectedUsers;
      if(numUsers==0){
          vidEl.firebase.remove();
      }
      vidEl.end();
      this.$.videoDiv.removeChild(vidEl);
      var textEl = this.$.textDiv.querySelector("textchat-element");
      var numUsers=textEl.connection.stats.numberOfConnectedUsers;
      if(numUsers==0){
        textEl.firebase.remove();
      }
      textEl.end();
      this.$.textDiv.removeChild(textEl);
    },
    
    toggleClass: function(element, className) {
      //var flexbox = this.shadowRoot.querySelector("#flexbox");
      var layoutDiv = this.shadowRoot.querySelector("#layout");
      var classes = element.className.split(/\s+/),
        length = classes.length;
     

      for(i = 0; i < length; i++) {
        if (classes[i] === className) {
          classes.splice(i, 1);
          //flexbox.style.width = "100%";
          if (layoutDiv === element){
          	layout.style.width = "100%";
          }
          break;
        }
      }
      // The className is not found
      if (length === classes.length) {
          classes.push(className);
          //flexbox.style.width = "calc(100% - 250px)";
          if (layoutDiv === element){
          	layout.style.width = "calc(100% - 250px)";
          }
      }

      element.className = classes.join(' ');
    }
  
     
  });
  </script>
</polymer-element>
