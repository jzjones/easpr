<link rel="stylesheet" href="../../leaflet/leaflet.css" />
<link rel="stylesheet" href="../index.css">
<script src="../../leaflet/leaflet.js"></script>

<link rel="import" href="../bower_components/polymer/polymer.html">
<script src="../jquery_webrtc/jq.js"></script>
<script src="../jquery_webrtc/rtc.js"></script>
<link href="../../bootstrap/css/bootstrap.min.css" rel="stylesheet">
<link href="../../css/demo.css" rel="stylesheet">
<script src="../../bootstrap/js/bootstrap.min.js"></script>

<polymer-element name="videochat-element" attributes="name sessionName">
  <template>
    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
          <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="#">Easpr Demo</a>
          </div>
          <div class="navbar-collapse collapse">
              <form class="navbar-form navbar-right" role="form">
                <div class="form-group" id="roomNav">
                    <input type="text" placeholder="Room name" id="roomName" name="roomName" class="form-control">
                </div>
                <button type="button" id="createBtn" class="btn btn-success" on-click="{{createRoom}}">Create Room</button>
                <button type="button" id="joinBtn" class="btn btn-success" on-click="{{joinRoom}}">Join Room</button>
                <div class="form-group">
                  <span><input type='checkbox' id='textEnable' >Enable Text</span>
                  <span><input type='checkbox' id='screenShare' >Screen Share</span>
                    <span id="roomSpan"></span>
                </div>
              </form>
          </div><!--/.navbar-collapse -->
        </div>
    </div>
<!--Trying tto make a grid to house text and video peer elements-->
    <div id='peerDiv' class='.container'>
      <div id='videoRow' class='row'></div>
      <div class='row'>
        <div class='col-md-6'>
          <div id='textChatDiv'>
            <span><textarea id='textArea' rows="4" cols="30"></textArea>
            <button type="button" id="textButton" class="btn btn-success" on-click="{{sendText}}">Send Text</button></span>
            <div>
              <textarea id='textBox'readonly></textarea>
            </div>
          </div>
        </div>
      </div>
      <div id="map"></div>
    </div>
  </template>

  <script>
  Polymer('videochat-element',{
    
    ready: function(){
      var mapEl = this.shadowRoot.querySelector("#map");
      
      var myIcon = L.icon({
    	    iconUrl: '../leaflet/images/marker-icon.png',
    	    iconRetinaUrl: '../leaflet/images/marker-icon-2x.png',
    	    iconSize: [38, 95],
    	    iconAnchor: [22, 94],
    	    popupAnchor: [-3, -76],
    	    shadowUrl: '../leaflet/images/marker-shadow.png',
    	    shadowRetinaUrl: '../leaflet/images/marker-shadow.png',
    	    shadowSize: [68, 95],
    	    shadowAnchor: [22, 94]
    	});
      
      this.connection = new RTCMultiConnection();
      this.joined = false;
      this.connection.session = {
        audio: true,
        video: true,
      }
	  
	  var map = L.map(mapEl).setView([51.505, -0.09], 13);
 	
	  L.tileLayer('http://{s}.tile.cloudmade.com/795f9e9d19094307867649e8d21d3f46/997/256/{z}/{x}/{y}.png', {
		  maxZoom: 18,
		  attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://cloudmade.com">CloudMade</a>'
  	  }).addTo(map);
	  var con = this.connection;
	  function onMapClick(e) {
		  marker = new L.marker(e.latlng, {icon:myIcon, draggable:'false'}).addTo(map);
		  var jsonMarker = JSON.stringify({"latlng": e.latlng});
		  console.log(this);
		  con.sendCustomMessage(jsonMarker);
	  }

	  map.on('click', onMapClick);
      
      this.connection.onclose = function(e){
        console.log("inside onclose");        
        console.log(this);        
        this.joined = false;  
      };

      this.connection.onstream = function(e){
        
        console.log("Adding video stream");
        $('#videoRow').append("<div class='col-md-6'></div>").append(e.mediaElement);  
      };

      this.connection.onstreamended = function(e){
        if(e.mediaElement.parentNode) e.mediaElement.parentNode.removeChild(e.mediaElement);
      };

      this.connection.onCustomMessage = function(message){
		var jsonMarker = JSON.parse(message);
		L.marker(jsonMarker.latlng, {icon:myIcon, draggable:'false'}).addTo(map);
    	/*
        var currentMessage=$('#textBox').val();

        $('#textBox').val(currentMessage+'\n'+message);*/
      };

      console.log("test");
      console.log(this.connection.channel);
    },
      
    
    createRoom:function(){
      if(this.joined){
        this.joined = false;
        this.connection.leave(); 
        $('#videoStream').empty();
        $('#textArea').val("");
        $('#textBox').val("");
      }
      
    
      this.connection.open($('#roomName').val());
      this.joined = true;
      $('#roomName').val("");
      this.connection.connect(this.connection.channel);
      this.connection.join({
            sessionid: this.connection.channel,
            userid: 'initiator-id',
            session: {audio:true,video:true,screen: $('#screenShare').is(':checked'),data:$('#textEnable').is(':checked')},
            extra: {}
        });
      console.log(this.connection.channel); 
    },

    joinRoom:function(){
      if(this.joined){
        this.joined = false;
        this.connection.leave();
        $('#videoStream').empty();
        $('#textArea').val("");
        $('#textBox').val("");
    
      }

      this.connection.connect($('#roomName').val());
      this.joined = true;
      this.connection.join({
          sessionid: this.connection.channel,
          userid: 'initiator-id',
          session: {audio:true,video:true,screen: $('#screenShare').is(':checked'),data:$('#textEnable').is(':checked')},
          extra: {}
      });
      console.log(this.connection.channel);
    },

    sendText: function(){

      var message=$('#textArea').val();
      this.connection.sendCustomMessage(message);
      var currentMessage=$('#textBox').val();
      $('#textBox').val(currentMessage+'\n'+message);
      $('#textArea').val("");
    }
  });
  </script>
</polymer-element>
